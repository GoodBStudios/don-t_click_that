
// Minimal, production-ready JS for Recover Together (modular functions)
const STORAGE_KEY='rt_data_v2';
const state=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// Theme
const themeToggle=document.getElementById('themeToggle');
(function applyTheme(){
  document.documentElement.dataset.theme=state.theme||'dark';
})();
themeToggle?.addEventListener('click',()=>{
  state.theme=state.theme==='light'?'dark':'light'; saveState();
  document.documentElement.dataset.theme=state.theme;
});

// Quotes
const QUOTES=["One day at a time — small wins add up.","You are not your urges. You are what you do repeatedly.","Progress, not perfection.","Replace the habit, don’t just resist it.","Accountability turns intention into action.","Every minute you resist, you grow stronger.","The urge is temporary; the reward of freedom is permanent.","Celebrate the tiny victories — they build the big ones."];
function setQuote(i){ const el=document.getElementById('quote'); const idx=(i===undefined?Math.floor(Math.random()*QUOTES.length):i)%QUOTES.length; if(el) el.textContent=QUOTES[idx]; state.lastQuote=idx; saveState(); }
document.getElementById('newQuote')?.addEventListener('click',()=>setQuote());
document.getElementById('copyQuote')?.addEventListener('click',()=>{ const q=document.getElementById('quote')?.textContent||''; navigator.clipboard.writeText(q).then(()=>alert('Quote copied')); });
setQuote(state.lastQuote||0);

// Timer
function human(ms){ if(ms<1000) return '0s'; const sec=Math.floor(ms/1000); const days=Math.floor(sec/86400); let rem=sec-days*86400; const hours=Math.floor(rem/3600); rem-=hours*3600; const mins=Math.floor(rem/60); const secs=rem-mins*60; let out=''; if(days) out+=days+'d '; if(hours) out+=hours+'h '; if(mins) out+=mins+'m '; out+=secs+'s'; return out; }
function updateTimerUI(){ const timerEl=document.getElementById('timer'); const milestonesEl=document.getElementById('milestones'); if(!state.start){ timerEl.textContent='Not set'; milestonesEl.textContent=''; return; } const dur=Date.now()-state.start; timerEl.textContent=human(dur)+'\n(since '+new Date(state.start).toLocaleString()+')'; const days=Math.floor(dur/86400000); const ms=[]; if(days>=7)ms.push('🎉 1 week'); if(days>=30)ms.push('🌟 1 month'); if(days>=90)ms.push('💪 3 months'); if(days>=365)ms.push('🏆 1 year'); milestonesEl.textContent=ms.join(', '); }
setInterval(updateTimerUI,1000);
document.getElementById('setStart')?.addEventListener('click',()=>{ const val=document.getElementById('startDate')?.value; if(!val) return alert('Choose a start date/time'); state.start=new Date(val).getTime(); saveState(); updateTimerUI(); });
document.getElementById('clearStart')?.addEventListener('click',()=>{ if(confirm('Clear start date?')){ delete state.start; saveState(); updateTimerUI(); } });
if(state.start){ const inp=document.getElementById('startDate'); if(inp) inp.value=new Date(state.start).toISOString().slice(0,16); }

// Journal
function loadJournal(){ return state.journal||[]; }
function saveJournalEntry(text){ state.journal=state.journal||[]; state.journal.unshift({text, date:new Date().toISOString()}); if(state.journal.length>500) state.journal.length=500; saveState(); renderJournalList(); }
function renderJournalList(){ const area=document.getElementById('recentLogs')||document.getElementById('journalList'); if(!area) return; const list=loadJournal(); if(list.length===0){ area.textContent='No entries.'; return; } area.innerHTML=''; list.slice(0,10).forEach(e=>{ const div=document.createElement('div'); div.className='card muted'; div.style.marginBottom='8px'; div.innerHTML='<div style="font-size:12px;color:var(--muted)">'+new Date(e.date).toLocaleString()+'</div><div>'+ (e.text.length>200? e.text.slice(0,200)+'...': e.text) +'</div>'; area.appendChild(div); }); }
document.getElementById('saveJournalBtn')?.addEventListener('click',()=>{ const t=document.getElementById('journalText')?.value; if(!t) return alert('Write something first'); saveJournalEntry(t); document.getElementById('journalText').value=''; });
document.getElementById('exportJournalBtn')?.addEventListener('click',()=>{ const data=JSON.stringify(loadJournal(),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='recover_together_journal.json'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('clearJournalBtn')?.addEventListener('click',()=>{ if(confirm('Clear all journal entries?')){ state.journal=[]; saveState(); renderJournalList(); } });
renderJournalList();

// IBAN & donations
document.getElementById('donateBtn')?.addEventListener('click',()=>{ const modal=document.getElementById('donationModal'); if(modal) modal.setAttribute('aria-hidden','false'); });
document.getElementById('closeModal')?.addEventListener('click',()=>{ const modal=document.getElementById('donationModal'); if(modal) modal.setAttribute('aria-hidden','true'); });
document.getElementById('saveIban')?.addEventListener('click',()=>{ const val=document.getElementById('ibanInput')?.value.trim(); if(!val) return alert('Enter IBAN'); state.iban=val; saveState(); alert('IBAN saved locally'); document.getElementById('ibanArea')&&(document.getElementById('ibanArea').textContent=val); });
document.getElementById('copyIban')?.addEventListener('click',()=>{ const v=state.iban; if(!v) return alert('No IBAN set'); navigator.clipboard.writeText(v).then(()=>alert('IBAN copied')); });
document.getElementById('showIban')?.addEventListener('click',()=>{ document.getElementById('ibanArea')&&(document.getElementById('ibanArea').textContent=state.iban||'No IBAN set'); });

// Quick links (can be customized in settings)
document.getElementById('paypalLink')?.setAttribute('href', state.paypal||'https://www.paypal.com/donate');
document.getElementById('kofiLink')?.setAttribute('href', state.kofi||'https://ko-fi.com');

// Accessibility: focus outlines for keyboard users
(function(){ document.body.addEventListener('keydown', e=>{ if(e.key==='Tab') document.documentElement.classList.add('show-focus'); }); })();
